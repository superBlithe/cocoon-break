

> ç‹æ¢¦ä½³ï¼šâ€œç†Šä¸œèµ·GGï¼Œæˆ‘æƒ³åƒæ°´æœ~â€

ç†Šä¸œèµ·ï¼šâ€œè¿™å“ªå—å¾—äº†ï¼Œç»™ä½ åˆ‡â€



å…ˆçœ‹çœ‹æ•ˆæœ
![åˆ‡è¥¿ç“œgif.gif](https://cdn.nlark.com/yuque/0/2021/gif/684024/1624331429403-909e5589-1e76-4179-9ae3-2db453fbe818.gif#clientId=u46e7712d-232e-4&from=drop&id=u95fed642&margin=%5Bobject%20Object%5D&name=%E5%88%87%E8%A5%BF%E7%93%9Cgif.gif&originHeight=621&originWidth=352&originalType=binary&ratio=2&size=1487634&status=done&style=none&taskId=udbb9ad3f-f9fa-4070-84ed-ccb4ae28401)


åºŸè¯è¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€æ•´ï¼


## æ–‡ç« ç´¢å¼•
å®Œæ•´ä»£ç ï¼š[http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step6](http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step6)
### æ–‡ç« å¾ˆå†—ä½™ï¼Œå¾ˆå¤šï¼Œå¤§å®¶ä¸å¿…ä»å¤´è·Ÿç€èµ°ï¼Œæ¯ä¸€èŠ‚éƒ½ä¼šæœ‰ä¸€ä¸ªåŸºç¡€ä»“åº“ï¼Œå¯ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿›è¡Œå¼€å‘ã€‚


- æ–¹æ¡ˆ
- step1: åˆå§‹åŒ–&ç®€å•å¸ƒå±€
- step2: åˆ€å…‰å®ç°
- step3: åˆ€ç¢°æ’æ°´æœï¼Œmatterjsç™»åœº 
   - matterjsç»“åˆFYGE
   - é‡åŠ›
   - ç¢°æ’

 

- step4: ç‰©ç†å¼•æ“&ç¢°æ’æ£€æµ‹
- step5: æ¸¸æˆé¡µ



## æ–¹æ¡ˆ


> æ¢ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å…ˆæ¥æ‹†è§£ï¼Œç„¶åè¯´å®ç°ã€‚å°±åƒæ‹¼ç§¯æœ¨ä¸€æ ·ï¼Œé€æ­¥å¥å®Œæˆã€‚



- **_ä¸¤_**ä¸ªåœºæ™¯ï¼š`å¼€å§‹é¡µ`ã€`æ¸¸æˆé¡µ`
- **_ä¸¤_**ä¸ªå…³é”®çš„ç±»ï¼š`æ°´æœ`ã€`åˆ€å…‰`
- ç‰©ç†å¼•æ“ï¼šé‡åŠ›ã€ç¢°æ’æ£€æµ‹



## å¯è·³è¿‡step1


## step1: åˆå§‹åŒ–&ç®€å•å¸ƒå±€


> ç‹æ¢¦ä½³è¯´ï¼šâ€œæˆ‘å•¥ä¹Ÿä¸ä¼šï¼Œå’‹åŠå‘¢~â€

ç†Šä¸œèµ·ï¼šé‚£æˆ‘ä»¬å°±ä»0å¼€å§‹å§~



### å·²ç»æå‰ç»™å¤§å®¶å‡†å¤‡å¥½äº†åˆå§‹é¡¹ç›®


å¤§å®¶å¯ä»¥å…‹éš†åŸºç¡€é¡¹ç›®ï¼š[http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step1](http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step1)


åŸºç¡€é¡¹ç›®éƒ½å¹²äº†å•¥å‘¢ï¼Ÿ


- å„ç±»å›¾ç‰‡
- åˆ›å»ºç›®å½•
- å…¥å£æ–‡ä»¶main.tsåŠ è½½è¿™äº›å›¾ç‰‡ï¼Œåé¢åªéœ€è¦ä»ç¼“å­˜å–å°±å¥½äº†
- å°è£…ä¸€äº›æ–¹æ³•



#### srcé¡¹ç›®ç›®å½•ï¼š


- componentsï¼š`å­˜æ”¾å„ç±»ç»„ä»¶ï¼Œæ¯”å¦‚èƒŒæ™¯ã€åˆ€å…‰ã€æ°´æœ` 
   - GameBg.ts

 

- config 
   - GameCfg.ts `æ¸¸æˆé…ç½®`
   - GUtils.ts `å·¥å…·æ–¹æ³•`

 

- GameScene 
   - GameScene.ts `æ¸¸æˆé¡µ`
   - StartScene.ts `å¼€å§‹é¡µ`

 

- main.ts `å…¥å£ï¼Œæ–‡ä»¶`



#### å¼€å§‹æ¸¸æˆæŒ‰é’®


å¼€å§‹æŒ‰é’®å…¶å®æ˜¯åˆ†ä¸ºåœ†ç¯å’Œè¥¿ç“œğŸ‰


å£°æ˜ç±»å‹


```typescript
export class StartScene extends FYGE.Container {
  /** å¼€å§‹æŒ‰é’® */
  private startBtnGroup: FYGE.Container;
  private btnOut: FYGE.Sprite;
  /** æ°´æœï¼šè¥¿ç“œã€‹ å¼€å§‹æŒ‰é’® */
  private xigua: Fruit;
  /** è¥¿ç“œçš„åŠ¨ç”» */
  private TweenXigu: FYGE.Tween;
```


çœŸæ­£çš„æŒ‰é’®è¥¿ç“œéœ€è¦æ˜¯ä¸€ä¸ªæ°´æœ

æˆ‘ä»¬è¿™é‡Œå…ˆæŠŠ`åœ†ç¯åŠåœ†ç¯çš„åŠ¨ç”»`

è®©å®ƒé€†æ—¶é’ˆè½¬èµ·æ¥


```typescript
  private initBtn() {
    this.startBtnGroup = this.addChild(new FYGE.Container());
    this.startBtnGroup.position.x = 200;
    this.startBtnGroup.position.y = 350;
    let btnOut = this.startBtnGroup.addChild(new FYGE.Sprite(getRes(RES_MAP.newGameBtnOut)));
    btnOut.anchorX = btnOut.anchorY = btnOut.width / 2;
    FYGE.Tween.get(btnOut, { loop: true }).to({ rotation: -360 }, 8000);
    this.btnOut = btnOut;
  }
```


#### ç®€å•æ°´æœç±»


ä¸ºä»€ä¹ˆå«`ç®€å•`æ°´æœç±»ï¼Ÿå› ä¸ºè¿™é‡Œä»…ä»…æ˜¯ä¸ªå±•ç¤ºçš„èŠ‚ç‚¹
å¼€å§‹é¡µçš„è¥¿ç“œï¼Œä»¥åŠæ¸¸æˆé¡µçš„å„ç±»æ°´æœã€‚éƒ½ä¼šä»è¿™ä¸ªç±»è¿›è¡Œæ‰©å±•ã€‚
æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„æ°´æœç±»ã€‚
**æ–°å»ºcomponents/Fruit.ts**


```typescript
import { FRUIT_NAME, RES_MAP, SS } from "../config/GameCfg";
import { ADD_SPRITE, getRes, GUtils } from "../config/GUtils";

export default class Fruit extends FYGE.Sprite {
  constructor() {
    super();
    /** é˜²æ­¢è´´å›¾ç¦ç”¨åï¼Œåé¢æ²¡åŠæ³•å¤ç”¨ã€‚ */
    this.texture = getRes(RES_MAP["fruitXigua"]).clone();
    this.anchorX = this.width / 2;
    this.anchorY = this.height / 2; 
  }
}
```


ç„¶åå‘¢ï¼Œåœ¨å¼€å§‹é¡µå¼•å…¥è¿›æ¥ï¼Œå¹¶è¿›è¡Œå£°æ˜


```typescript
 /** æ°´æœï¼šè¥¿ç“œã€‹ å¼€å§‹æŒ‰é’® */
  private xigua: Fruit;
```


ç„¶åå†initBtnæ–¹æ³•ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶æ·»åŠ é¡ºæ—¶é’ˆæ—‹è½¬çš„åŠ¨æ•ˆ


```typescript
  let xigua = this.addChild(new Fruit());
  xigua.x = 250;
  xigua.y = 400;
  this.TweenXigu = FYGE.Tween.get(xigua, { loop: true }).to({ rotation: 360 }, 4000);
  this.xigua = xigua;
```


åŸºç¡€æ­å»ºå®Œäº‹äº†ï¼Œæˆ‘ä»¬ä¸‹é¢ä¼šè¿›è¡Œåˆ€å…‰çš„ç»˜åˆ¶


## step2: åˆ€å…‰å®ç°


æœ¬èŠ‚èµ·å§‹é¡¹ç›®ï¼š[http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step2](http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step2)


> ç‹æ¢¦ä½³ï¼šâ€å¥½å“äººå–”~ï¼Œè¿˜æœ‰åˆ€å…‰ï¼â€œ

ç†Šä¸œèµ·ï¼šâ€å¿…é¡»çš„å•Šï¼Œä¸å…‰å¼€å§‹é¡µæœ‰ï¼Œæ¸¸æˆé¡µä¹Ÿè¦æœ‰ï¼Œè€Œä¸”è¿˜è¦å‚ä¸åé¢çš„ç¢°æ’æ£€æµ‹å‘¢~â€œ



åˆ€å…‰å…¶å®æ˜¯ç”»çš„å¤šè¾¹å½¢ã€‚`drawPolygon`å¯ä»¥æ¥å—ä¸€ç»„åæ ‡`Points`ã€‚


`é¼ æ ‡ç§»åŠ¨`çš„æ—¶å€™ï¼Œè¿›è¡Œæ•è·åæ ‡ã€‚
`é¼ æ ‡æŠ¬èµ·`çš„æ—¶å€™ï¼Œæ¸…é™¤ç»˜åˆ¶å†…å®¹ã€‚


é‚£å°±å¼€å§‹å§~
**æ–°å»ºcomponents/Blade.ts**


```typescript
import { RES_MAP, SS } from "../config/GameCfg";
import Tpoint from "./Tpoint";

//æ¯ä¸ªç‚¹å­˜æ´»æ—¶é—´
const POINTLIFETIME = 100;
export default class Blade extends FYGE.Graphics {
  private points: Tpoint[] = [];

  public drawBlade(e: FYGE.MouseEvent) {
    this.clear();
    let point = new Tpoint(e.localX, e.localY);
    point.time = new Date().getTime();
    this.points.push(point);
    if (new Date().getTime() - this.points[0].time > POINTLIFETIME) {
      this.points.shift();
    }
    // ç‚¹å¤ªå°‘ï¼Œè¯¯è§¦
    if (this.points.length < 2) return;
    this.beginFill(0xffffff);
    this.drawPolygon(this.points);
    this.endFill();
  }

  public reset() {
    this.points = [];
    this.clear();
  }
}
```


> ç‹æ¢¦ä½³ï¼šâ€`Tpoint`æ˜¯ä¸ªå•¥å•Šï¼Ÿâ€œ

ç†Šä¸œèµ·ï¼šâ€å°±æ˜¯ä¸ªæ™®é€šçš„Point, æ‰©å±•ä¸€ä¸ªtimeå­—æ®µã€‚ä½ è‡ªå·±æ–°å»ºå§ã€‚â€œ

ç†Šä¸œèµ·ï¼šâ€æˆ‘ä»¬è¦æ·»åŠ äº‹ä»¶å’¯ã€‚â€œ
**StartScene.ts**



```typescript
  /** åˆ€å…‰ */
  private blade: Blade;
  // init() é‡Œæ·»åŠ 
  this.blade = this.addChild(new Blade());

/** ç›‘å¬äº‹ä»¶ */
  private addEvents() {
    this.stage.addEventListener(FYGE.MouseEvent.MOUSE_MOVE, this.onMouseMove, this);
    this.stage.addEventListener(FYGE.MouseEvent.MOUSE_UP, this.onMouseUp, this);
  }

  /** ç§»é™¤äº‹ä»¶ */
  private removeEvents() {
    this.stage.removeEventListener(FYGE.MouseEvent.MOUSE_MOVE, this.onMouseMove, this);
    this.stage.removeEventListener(FYGE.MouseEvent.MOUSE_UP, this.onMouseUp, this);
  }

  private onMouseUp() {
    this.blade.reset();
  }

  /** é¼ æ ‡ç§»åŠ¨ */
  private onMouseMove(e) {
    _throttle(this.blade.drawBlade(e), 50);
    // this.blade.checkCollide(this.xigua, this.doStart.bind(this));
  }
```


## step3: åˆ€ç¢°æ’æ°´æœï¼Œmatterjsç™»åœº


æœ¬èŠ‚èµ·å§‹é¡¹ç›®ï¼š[http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step3](http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step3)


å¦‚æœåªæ˜¯å¼€å§‹æŒ‰é’®çš„è¥¿ç“œç¢°æ’æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨FYGEçš„`ç‚¹å’Œç‰©ä½“sprite.hitTestPoint`çš„æ–¹æ³•ã€‚äº‹å®ä¸Šæˆ‘åˆšå¼€å§‹ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ã€‚
ä½†æ˜¯åé¢è¿˜è¦æ¨¡æ‹Ÿé‡åŠ›ï¼Œæ¨¡æ‹Ÿç‰©ä½“å’Œç‰©ä½“ç¢°æ’ã€‚æ‰€ä»¥å°±å¼•å…¥äº†matterjsã€‚
**å®‰è£…matterjs**


```
  yarn add matter-js @types/matter-js -S
```


### æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ


ä¹‹å‰æ‰“ç –å—æ–‡ç« æœ‰èŠè¿‡ä¸€äº›ç”¨æ³•ã€‚å¯ä»¥ç»“åˆå‚è€ƒã€‚æˆ‘ä»¬è¿™é‡Œç§°matterjsåˆ›å»ºçš„ä¸º`ç‰©ç†ä¸–ç•Œ`ï¼ŒFYGEåˆ›å»ºçš„ç§°ä¸º`è§†å›¾ä¸–ç•Œ`ã€‚


- é¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªç‰©ç†ä¸–ç•Œ
- ç„¶åå‘¢? åœ¨ç‰©ç†ä¸–ç•Œç”»ä¸€äº›åˆšä½“ï¼Œå’Œå½“å‰çš„FYGEé‡Œé¢çš„èŠ‚ç‚¹ç»‘å®šèµ·æ¥
- ç›‘å¬ç‰©ç†ä¸–ç•Œï¼Œæ”¹å˜è§†å›¾ä¸–ç•Œ



#### åˆ›å»ºç‰©ç†ä¸–ç•Œ


éšè—èƒŒæ™¯(æ–¹ä¾¿è°ƒè¯•)ï¼Œç„¶åæ‰§è¡Œåˆ›å»ºç‰©ç†ä¸–ç•Œæ–¹æ³•, è°ƒè¯•çš„æ—¶å€™æŠŠrenderæ¸²æŸ“æ‰“å¼€


**init()**


```typescript
// this.addChild(new GameBg());
  this.createPhyWorld()
```


**createPhyWorld()**


```typescript
  /** åˆ›å»ºç‰©ç†ä¸–ç•Œ */
   private createPhyWorld() {
    const { Engine, Render, Runner, Composite, Bodies, World, Composites } = Matter;
    this.engine = Engine.create();
    this.world = this.engine.world;
     this.engine.gravity.y = 0;
     
    /** çœŸæ­£è¿è¡Œ */
    this.runner = Runner.create();
    Runner.run(this.runner, this.engine);
    // @ts-ignore
    this.composites = Composite;
     
    // ä¸´æ—¶æ¸²æŸ“å¼•æ“ï¼Œè°ƒè¯•ç”¨
    var render = Render.create({
      element: document.body,
      engine: this.engine,
      options: {
        width: 750,
        height: 600,
      },
    });
    Render.run(render);
  }
```


#### å¢åŠ ç‰©ç†ä¸–ç•Œçš„åˆ€å…‰


æˆ‘ä»¬åªéœ€è¦æ‰©å±•Bladeç±»ï¼Œç„¶åå¢åŠ ä¸€ä¸ªå±æ€§PhyBodyã€‚
åœ¨ç»˜åˆ¶åˆ€å…‰çš„æ—¶å€™ï¼ŒåŒæ—¶åœ¨ç‰©ç†ä¸–ç•Œç»˜åˆ¶ä¸€ä»½ã€‚
æˆ‘ä»¬åœ¨æ¯æ¬¡ç»˜åˆ¶`drawBlade`æ–¹æ³•ä¹‹å‰éƒ½è¦æ¸…é™¤ä¹‹å‰çš„ç»˜åˆ¶ã€‚


`SS` æ˜¯ `SS = document.body.clientWidth / 750;` ä¸ºäº†åŒæ­¥ä¸¤ä¸ªä¸–ç•Œåæ ‡çš„æ¢ç®—æ¯”ä¾‹ã€‚


å®Œæ•´çš„åˆ€å…‰ä»£ç 
**Blade.ts**


```typescript
import * as Matter from "matter-js";
import { RES_MAP, SS } from "../config/GameCfg";
import Tpoint from "./Tpoint";

//æ¯ä¸ªç‚¹å­˜æ´»æ—¶é—´
const POINTLIFETIME = 100;
export default class Blade extends FYGE.Graphics {
  private points: Tpoint[] = [];
  private _body: Matter.Body;
  get phyBody(): Matter.Body {
    return this._body;
  }
  set phyBody(v: Matter.Body) {
    this._body = v;
  }

  public drawBlade(e: FYGE.MouseEvent) {
    this.clear();
    let point = new Tpoint(e.localX, e.localY);
    point.time = new Date().getTime();
    this.points.push(point);
    if (new Date().getTime() - this.points[0].time > POINTLIFETIME) {
      this.points.shift();
    }
    // ç‚¹å¤ªå°‘ï¼Œè¯¯è§¦
    if (this.points.length < 2) return;
    this.beginFill(0xffffff);
    this.drawPolygon(this.points);
    this.endFill();
    // @ts-ignore
    this.phyBody && this.parent.composites.remove(this.parent.world, [this.phyBody]);
    // ç‰©ç†ä¸–ç•Œä¹Ÿè·Ÿç€ä¸€èµ·ç”»
    this.phyBody = Matter.Bodies.fromVertices(
      e.localX * SS,
      e.localY * SS,
      [
        this.points.map((p) => {
          let { x, y } = p;
          return { x: x * SS, y: y * SS };
        }),
      ],
      {
        isStatic: true,
      }
    );
    // @ts-ignore
    this.parent.composites.add(this.parent.world, [this.phyBody]);
  }

  public reset() {
    this.points = [];
    this.clear();
    // @ts-ignore
    this.phyBody && this.parent.composites.remove(this.parent.world, [this.phyBody]);
  }
}
```


åˆ€å…‰å°±æˆäº†~


### ä¹Ÿç»™æ°´æœ-è¥¿ç“œæ·»åŠ ä¸€ä¸ªç‰©ç†åˆšä½“


æ–¹æ³•è·Ÿåˆ€å…‰ä¸€æ ·ï¼Œè¿™é‡Œç›´æ¥è´´ä»£ç äº†


```typescript
export default class Fruit extends FYGE.Sprite {
  public phyBody: Matter.Body;
  constructor() {
    super();
    /** é˜²æ­¢è´´å›¾ç¦ç”¨åï¼Œåé¢æ²¡åŠæ³•å¤ç”¨ã€‚ */
    this.texture = getRes(RES_MAP["fruitXigua"]).clone();
    this.anchorX = this.width / 2;
    this.anchorY = this.height / 2; 
    this.phyBody = Matter.Bodies.circle(this.x * SS, this.y * SS, (this.width / 2) * SS, {
      isStatic: true,
      isSensor: true, // ä¼ æ„Ÿå™¨ï¼Œå¯ä»¥æ£€æµ‹åˆ°ç¢°æ’ï¼Œä½†æ˜¯ä¸å‚ä¸ç¢°æ’
      render: { fillStyle: "#060a19" },
      collisionFilter: { group: -1 }, // å‚è€ƒreademeé‡Œé¢çš„ç¢°æ’è§„åˆ™
    });
    this.setPhyPos();
  }
  set fx(value: number) {
    this.position.x = value;
    this.setPhyPos();
  }

  set fy(value: number) {
    this.position.y = value;
    this.setPhyPos();
  }

  setPhyPos() {
    Matter.Body.setPosition(this.phyBody, {
      x: (this.x + this.width / 2) * SS,
      y: (this.y + this.height / 2) * SS,
    });
  }
}
```


ç„¶åå‘¢ï¼Ÿ
åœ¨é¦–é¡µ`initBtn`æ–¹æ³•é‡Œ, æŠŠè¥¿ç“œåˆšä½“æ·»åŠ è¿›å»ï¼Œç„¶åæŠŠx,yæ”¹æˆ`fx`ã€ `fy`ï¼Œè¿™æ ·ä¼šåŒæ—¶è®¾ç½®è§†å›¾ä¸–ç•Œä»¥åŠç‰©ç†åˆšä½“çš„åæ ‡ã€‚


```
xigua.fx = 250;
xigua.fy = 400;
// @ts-ignore
this.composites.add(this.world, [xigua.phyBody]);
```


ä¸‹é¢æˆ‘ä»¬è¦å¼€å¯ç‰©ç†å¼•æ“åŠç¢°æ’äº†


## step4: ç‰©ç†å¼•æ“&ç¢°æ’æ£€æµ‹


æœ¬èŠ‚èµ·å§‹é¡¹ç›®ï¼š[http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step4](http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step4)


> ç‹æ¢¦ä½³ï¼šâ€è¿™æ˜¯è¦å¼€å§‹åˆ‡æ°´æœäº†å—ï¼Ÿâ€œ

ç†Šä¸œèµ·ï¼šâ€æ˜¯çš„å‘€ï¼ŒMMâ€œ



ä¸å‡ºæ„å¤–çš„è¯ï¼Œå¯ä»¥åœ¨å±å¹•ä¸Šçœ‹åˆ°è¥¿ç“œï¼Œä»¥åŠåˆ€å…‰éƒ½æœ‰ä¸ª`ç™½è‰²çš„æ¡†æ¡†`äº†ã€‚æ²¡é”™ï¼Œé‚£ä¸ªå°±æ˜¯ç‰©ç†ä¸–ç•Œç”»çš„åˆšä½“ã€‚

å¦‚æœæœ‰æ„å¤–ï¼Œæ‰¾`@å¼ è¶…`ã€‚


`è¥¿ç“œ`å’Œ`åˆ€å…‰`è¿™ä¿©ç‰©ç†åˆšä½“éƒ½å·²ç»ç»˜åˆ¶å®Œæˆï¼Œä¸‹é¢å°±è¦è®©ä»–ä»¬è¿›è¡Œç¢°æ’ã€‚


é¦–å…ˆåœ¨`initBtn()`åŠ ä¸Š, å¼€å§‹æ¸¸æˆé¡µï¼Œæˆ‘ä»¬å·²ç»æŠŠé‡åŠ›è®¾ç½®æˆ0äº†ï¼Œæ‰€ä»¥ä¸ç”¨staticäº†`


```typescript
  Matter.Body.setStatic(this.xigua.phyBody, false);
```


ç„¶ååœ¨`createPhyWorld()`ä¸­æ·»åŠ äº‹ä»¶ç›‘å¬


```typescript
  Matter.Events.on(this.engine, "collisionStart", this.onCollisionStart.bind(this));
```


æ·»åŠ å¯¹åº”çš„æ–¹æ³•


```typescript
 /** åˆ’è¿‡å¼€å§‹æŒ‰é’® */
  doStart() {
    alert("å¼€å§‹æ¸¸æˆ");
  }
  /**
   * @description: ç¢°æ’æ£€æµ‹
   */
  onCollisionStart(e) {
    let pairs = e.pairs;
    if (this.xigua.phyBody.id === pairs[0].bodyA.id) {
      this.doStart();
    }
  }
```


### é’¢é“ç¢°æ’ä¼šè§¦å‘ï¼Œä¸€ä¸ª`collisionStart`å›è°ƒï¼Œç„¶åæˆ‘ä»¬åˆ¤æ–­é’¢é“çš„idæ˜¯ä¸æ˜¯è¥¿ç“œçš„idå°±å¯ä»¥äº†ã€‚ç”±äºè¥¿ç“œ`ä¸èƒ½è¢«ç¢°è·‘`,æ‰€ä»¥è¥¿ç“œåˆšä½“åŠ ä¸ªå±æ€§`isSensor`


```typescript
isSensor: true, // ä¼ æ„Ÿå™¨ï¼Œå¯ä»¥æ£€æµ‹åˆ°ç¢°æ’ï¼Œä½†æ˜¯ä¸å‚ä¸ç¢°æ’
```


å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œè¥¿ç“œçš„åˆšä½“å·²ç»æ‰è½äº†ã€‚


ç„¶åè¿™æ ·å°±å¯ä»¥`alert`å¼€å§‹æ¸¸æˆäº†
å¼€å§‹æ¸¸æˆæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹å‡ ä¸ªå¤„ç†


- è¥¿ç“œåˆ‡å¼€ï¼Œ
- è¥¿ç“œæ‰è½
- æ¸…é™¤å½“å‰é¡µé¢ï¼Œè¿›å…¥æ–°çš„



```typescript
  /** åˆ’è¿‡å¼€å§‹æŒ‰é’® */
  doStart() {
    this.engine.gravity.y = 1.2;
    /** åœæ­¢è¥¿ç“œè½¬åŠ¨ */
    FYGE.Tween.removeTweenSelf(this.TweenXigu);
    this.btnOut.visible = false;
    // this.xigua.doHalf();
    this.removeEvents();
    setTimeout(() => {
      // @ts-ignore
      this.composites.clear(this.world, true);
      Matter.Runner.stop(this.runner);
      Matter.Engine.clear(this.engine);
      this.parent.addChild(new GameScene());
      this.parent.removeChild(this);
    }, 1000);
  }
```


å¤§å®¶çœ‹ä¸Šé¢ä»£ç ï¼Œçœ‹åˆ°æœ‰ä¸ªdoHalfã€‚å°±æ˜¯åˆ‡è¥¿ç“œäº†ï¼Œç›®å‰å…ˆæ³¨é‡Šã€‚


### è§†å›¾ä¸–ç•Œçš„è¥¿ç“œæ‰è½


å¤§å®¶åˆšæ‰éƒ½çœ‹åˆ°äº†ç‰©ç†åˆšä½“çš„æ‰è½ï¼Œè€Œè§†å›¾ä¸–ç•Œçš„è¥¿ç“œè¿˜åœ¨åŸåœ°ã€‚
å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æ¯ä¸€å¸§å»å–ç‰©ç†åˆšä½“çš„åæ ‡ï¼Œç„¶åæ›´æ”¹è§†å›¾ä¸–ç•Œè¥¿ç“œçš„åæ ‡ã€‚
**Fruit.ts constructor()**


```typescript
   this.addEventListener(
      FYGE.Event.ADDED_TO_STAGE,
      () => {
        this.addEventListener(FYGE.Event.ENTER_FRAME, this.onFarm, this);
      },
      this
    );
```


**Fruit.ts onFarm()**


```typescript
  /** æ ¹æ®ç‰©ç†åˆšä½“ï¼Œæ›´æ–°å½“å‰çš„åæ ‡ã€‚ */
  private onFarm() {
    this.x = this.phyBody.position.x / SS - this.width / 2;
    this.y = this.phyBody.position.y / SS - this.height / 2;
  }
```


### è¥¿ç“œåˆ‡å¼€


è¿™ä¸ªæ›´ç®€å•ï¼Œå°±æ˜¯åŸæ¥çš„å›¾éšè—ï¼Œç„¶åç»™è¿™ä¸ªè¥¿ç“œæ·»åŠ ä¸¤ä¸ªå­èŠ‚ç‚¹ã€‚å›¾ç‰‡æå‰å‡†å¤‡å¥½äº†ã€‚


**Fruit.ts**


```typescript
  /** æ°´æœçš„ä¸¤åŠæ˜¯ä¸¤ä¸ªä¸åŒçš„å›¾ã€‚ */
  private half_pre: FYGE.Sprite;
  private half_next: FYGE.Sprite;
 /** åˆ‡æˆ2åŠ */
   doHalf() {
    if (this.half_next || this.half_pre) return;
    this.half_pre = this.addChild(ADD_SPRITE(getRes(RES_MAP["fruitXigua" + "1"]), -5, 0));
    this.half_next = this.addChild(ADD_SPRITE(getRes(RES_MAP["fruitXigua" + "2"]), 5, 0));
    this.texture.valid = false;
    FYGE.Tween.get(this.half_pre).to({ x: GUtils.getRandom(-120, -80), rotation: GUtils.getRandom(-50, -30) }, GUtils.getRandom(2000, 4000));
    FYGE.Tween.get(this.half_next).to({ x: GUtils.getRandom(80, 120), rotation: GUtils.getRandom(30, 50) }, GUtils.getRandom(2000, 4000));
    Matter.Body.setStatic(this.phyBody, false);
  }
```


å†çœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯å°±æœ‰äº†åˆ‡å¼€åŠ¨ç”»äº†ã€‚
`RES_MAP["fruitXigua" + "1"]` æœ‰äººæ³¨æ„åˆ°è¿™å¥è¯äº†ä¹ˆï¼Œä¸¤ä¸ªå­—ç¬¦ä¸²ä½ æç€+å•¥+?

ç°åœ¨åªæœ‰è¥¿ç“œä¹ˆ~ï¼Œåé¢è¿˜æœ‰å…¶ä»–æ°´æœï¼Œæ¯ä¸ªæ°´æœçš„åˆ‡å¼€ï¼Œéƒ½æ˜¯æ°´æœåå­—+â€œ1â€


------------è‡³æ­¤ï¼Œå¼€å§‹é¡µå°±å®Œæˆäº†ã€‚ä¸‹é¢æˆ‘ä»¬è¿›è¡Œæ¸¸æˆé¡µã€‚


## step5: æ¸¸æˆé¡µ


æœ¬èŠ‚èµ·å§‹é¡¹ç›®ï¼š[http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step5](http://gitlab2.dui88.com/no.4/cocoon-break/tree/mooc/fruit-step5)


> ç‹æ¢¦ä½³ï¼š"ç†ŠGGï¼Œç»ˆäºè¦å¼€å§‹æ¸¸æˆäº†å˜›ï¼Œå¥½æœŸå¾…å•Š"

ç†Šä¸œèµ·ï¼šâ€æƒ³å¤šå•¦ï¼Œå‰é¢åŸºæœ¬éƒ½å·²ç»å®ç°äº†ï¼Œæ¸¸æˆé¡µä¹Ÿä¸è¿‡æ˜¯ç®€å•çš„éšæœºæ°´æœï¼Œè®°ä¸ªåˆ†å•¥çš„â€œ
å¦‚ä¸Šä»–ä¿©æ‰€è¿°ï¼Œæ¸¸æˆé¡µå·²ç»æ²¡æœ‰ä»€ä¹ˆæ–°ç©æ„äº†ã€‚



### æ‰©å±•æ°´æœ


- æ°´æœçš„åå­—åŠ¨æ€å–
- ç»™æ°´æœåŠ ä¸€ä¸ªæ˜¯å¦æ­»äº¡çš„çŠ¶æ€
**Fruit.ts**



```typescript
  public die: boolean = false;
  /** æ°´æœåå­— */
  private fName: FRUIT_NAME;

   constructor(fName: FRUIT_NAME = "fruitXigua") {
    super();
    this.fName = fName;
    /** é˜²æ­¢è´´å›¾ç¦ç”¨åï¼Œåé¢æ²¡åŠæ³•å¤ç”¨ã€‚ */
    this.texture = getRes(RES_MAP[this.fName]).clone();
   }
```


åˆ‡å¼€çš„äº‹ä»¶é‡Œé¢ä¹Ÿæ¢æˆçœŸå®æ°´æœå›¾ç‰‡ï¼Œä»¥åŠdieçŠ¶æ€
**Fruit.ts doHalf**


```typescript
this.half_pre = this.addChild(ADD_SPRITE(getRes(RES_MAP[this.fName + "1"]), -5, 0));
this.half_next = this.addChild(ADD_SPRITE(getRes(RES_MAP[this.fName + "2"]), 5, 0));
this.die = true;
```


### ä¸‹é¢å‡ ä¸ªä¹‹å‰éƒ½è®²è¿‡äº†ã€‚è¿™é‡Œç›´æ¥è´´å‡ºæºç 


- åˆ›å»ºç‰©ç†ä¸–ç•Œ
- ç”Ÿæˆæ°´æœ
- éšæœºåˆå§‹åŒ–æ°´æœ
- ç»™æ°´æœä¸€ä¸ªåä½œç”¨åŠ›



å®Œæ•´çš„GameScene.ts


```typescript
import Blade from "../components/blade";
import Fruit from "../components/Fruit";
import GameBg from "../components/GameBg";
import { RES_MAP, FRUIT_NAME, FRUIT_ARRAY, OVER_COUNT } from "../config/GameCfg";
import { ADD_TEXT, GUtils, _throttle } from "../config/GUtils";
import * as Matter from "matter-js";
import { StartScene } from "./StartScene";

export class GameScene extends FYGE.Container {
  private engine: Matter.Engine;
  private world: Matter.World;
  private render: Matter.Render;
  private runner: Matter.Runner;
  private composites: Matter.Composite;
  private gameover: boolean = false;
  /** æ°´æœlist */
  private fruits: Fruit[] = [];
  /** æ°´æœçš„æœ€å¤§æ•°é‡ï¼Œä¼šéšç€åˆ†æ•°å¢åŠ éš¾åº¦ */
  private fruitMax: number = 4;

  /** å…³å¡ */
  private _lv: number = 1;
  /** å…³å¡æ–‡å­— */
  private lvText: FYGE.TextField;
  private get lv(): number {
    return this._lv;
  }
  private set lv(v: number) {
    this._lv = v;
    this.lvText && (this.lvText.text = "ç¬¬" + v + "å…³");
  }
  /** åˆ€å…‰ */
  private blade: Blade;
  /** åˆ†æ•°æ–‡å­— */
  private scoreText: FYGE.TextField;
  /** åˆ†æ•° */
  private _score: number = 0;
  private get score(): number {
    return this._score;
  }
  private set score(v: number) {
    this._score = v;
    this.scoreText && (this.scoreText.text = "åˆ†æ•°:" + v);
    FYGE.Tween.removeTweens(this.scoreText);
    FYGE.Tween.get(this.scoreText)
      .set({ scaleX: 1, scaleY: 1, anchorX: 30 })
      .to({ scaleX: 1.1, scaleY: 1.1, alpha: 1 }, 100)
      .to({ scaleX: 1, scaleY: 1 }, 50);
    if (v > 10) {
      this.lv = Math.ceil(v / 10);
    }
  }
  /** ä¸¢æ‰çš„æ•°é‡ */
  private _dieCount: number = 0;
  /** æ–‡å­— */
  private dieCountText: FYGE.TextField;
  private get dieCount(): number {
    return this._dieCount;
  }
  private set dieCount(v: number) {
    this._dieCount = v;
    this.dieCountText && (this.dieCountText.text = "ä¸¢å¤±:" + v);
    // ä¸¢çš„å¤ªå¤šäº†ï¼Œæ¸¸æˆç»“æŸ
    v >= OVER_COUNT &&
      (this.gameover = true) &&
      setTimeout(() => {
        this.gameOver();
      }, 17);
  }
  constructor() {
    super();
    this.addEventListener(
      FYGE.Event.ADDED_TO_STAGE,
      () => {
        this.addEvents();
        this.initGame();
      },
      this
    );
  }

  /** åˆå§‹åŒ–æ¸¸æˆ */
  initGame() {
    this.addChild(new GameBg());

    this.blade = this.addChild(new Blade());

    this.createPhyWorld();
    /** å½“ç„¶æ˜¯ç”Ÿæˆæ°´æœäº† */
    this.genneratorFruit();
    /** å…³å¡ */
    this.lvText = this.addChild(ADD_TEXT("ç¬¬1å…³", 30, "#66ff00", 50, 50));
    /** åˆ†æ•° */
    this.scoreText = this.addChild(ADD_TEXT("åˆ†æ•°:0", 40, "#66ffff", this.stage.width / 2 - 50, 50));
    /** ä¸¢å¤±è·‘æ‰çš„æ°´æœ */
    this.dieCountText = this.addChild(ADD_TEXT("ä¸¢å¤±:0", 30, "#ff3399", this.stage.width - 150, 50));
  }
  /** åˆ›å»ºç‰©ç†ä¸–ç•Œ */
  private createPhyWorld() {
    const { Engine, Render, Runner, Composite, Bodies, World, Composites } = Matter;
    this.engine = Engine.create();
    this.world = this.engine.world;
    this.engine.gravity.y = 0.5;
    // ä¸´æ—¶æ¸²æŸ“å¼•æ“ï¼Œè°ƒè¯•ç”¨
    var render = Render.create({
      element: document.body,
      engine: this.engine,
      options: {
        width: 750,
        height: 600,
      },
    });

    Render.run(render);

    /** çœŸæ­£è¿è¡Œ */
    this.runner = Runner.create();
    Runner.run(this.runner, this.engine);
    // @ts-ignore
    this.composites = Composite;
    Matter.Events.on(this.engine, "collisionStart", this.onCollisionStart.bind(this));
  }
  /** ç”Ÿæˆæ°´æœ */
  genneratorFruit() {
    if (this.gameover) return;
    while (this.fruits.length < this.fruitMax + this.lv) {
      this.randomFruit();
    }
  }

  /** éšæœºæ°´æœ */
  randomFruit() {
    let index = Math.floor(Math.random() * FRUIT_ARRAY.length);
    let fruit = new Fruit(FRUIT_ARRAY[index]);

    fruit.fx = GUtils.getRandom(this.stage.width * 0.25, this.stage.width * 0.75);
    fruit.fy = this.stage.height;
    // @ts-ignore
    this.composites.add(this.world, [fruit.phyBody]);

    FYGE.Tween.get(fruit, { loop: true }).to({ rotation: 360 }, 4000);

    this.addChild(fruit);
    // timeoutæ˜¯ è°ƒè¯•ç”¨çš„
    setTimeout(() => {
      if (!this.stage) return;
      Matter.Body.setStatic(fruit.phyBody, false);
      let sh = this.stage.height / 1334;
      Matter.Body.setVelocity(fruit.phyBody, { x: GUtils.getRandom(-3, 3), y: GUtils.getRandom(-15 * sh, -12 * sh) });
    }, GUtils.getRandom(0, 2000));
    this.fruits.push(fruit);
  }

  /**
   * @description: ç¢°æ’æ£€æµ‹
   */
  onCollisionStart(e) {
    let pairs = e.pairs;
    pairs.map((p) => {
      let needHalf = this.fruits.find((fruit) => fruit.phyBody?.id === p.bodyA?.id);
      !needHalf?.die && (this.score += 1) && needHalf?.doHalf();
    });
  }
  /** é¼ æ ‡ç§»åŠ¨ */
  private onMouseMove(e) {
    _throttle(this.blade.drawBlade(e), 50);
    /** åºŸå¼ƒï¼Œæœ¬æ¥æ˜¯ç”¨çš„hitTestPointæ¥åšçš„ç¢°æ’æ£€æµ‹ã€‚ */
    // this.blade.checkCollide(this.xigua, this.doStart.bind(this));
  }

  /** ç›‘å¬äº‹ä»¶ */
  private addEvents() {
    this.stage.addEventListener(FYGE.MouseEvent.MOUSE_MOVE, this.onMouseMove, this);
    this.stage.addEventListener(FYGE.MouseEvent.MOUSE_UP, this.onMouseUp, this);
    this.addEventListener(FYGE.Event.ENTER_FRAME, this.onFarm, this);
  }

  /** ç§»é™¤äº‹ä»¶ */
  private removeEvents() {
    this.stage.removeEventListener(FYGE.MouseEvent.MOUSE_MOVE, this.onMouseMove, this);
    this.stage.removeEventListener(FYGE.MouseEvent.MOUSE_UP, this.onMouseUp, this);
    this.removeEventListener(FYGE.Event.ENTER_FRAME, this.onFarm, this);
  }

  private onMouseUp() {
    this.blade.reset();
  }

  private onFarm() {
    this.fruits.map((f, i) => {
      if (f.y > this.stage?.height) {
        console.log("ä½ èµ°", f.die);
        // è·‘å‡ºå»çš„æ°´æœå¦‚æœè¿˜å­˜æ´»ï¼Œå°±ä¸¢å¤±+1
        if (!f.die) {
          this.dieCount += 1;
        }
        this.removeChild(f);
        this.fruits.splice(i, 1);
        this.genneratorFruit();
      }
    });
  }

  /**
   * @description: æ¸¸æˆç»“æŸ
   */
  private gameOver() {
    this.removeEvents();
    this.removeAllChildren();

    alert("æ¸¸æˆç»“æŸ");
    // @ts-ignore
    this.composites.clear(this.world, true);
    Matter.Runner.stop(this.runner);
    Matter.Engine.clear(this.engine);
    this.parent.addChild(new StartScene());
    this.parent.removeChild(this);
  }
}
```


è¿™é‡Œæ‹“å±•ä¸‹ç¢°æ’æ£€æµ‹çš„è§„åˆ™
æ¯”å¦‚æ°´æœä¸èƒ½å’Œæ°´æœè¿›è¡Œç¢°æ’ã€‚
æˆ‘ä»¬ç›´æ¥ä½¿ç”¨`collisionFilter` çš„`group`å±æ€§ã€‚
å¦‚æœæ›´å¤æ‚çš„å¯ä»¥å‚è€ƒä¸‹é¢


### ç¢°æ’æ£€æµ‹è§„åˆ™


> ç®€å•çš„ç¢°æ’å…³ç³»ï¼Œç›´æ¥è®¾ç½®`group`å³å¯å¤æ‚çš„ç¢°æ’å…³ç³»ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®`category`å’Œå’Œ`mask`å€¼è¿›è¡Œæ­é…ï¼Œåšå‡ºå¾ˆé«˜çº§çš„ç¢°æ’å…³ç³»



Matterç›¸äº’ç¢°æ’æä¾›äº†collisionFilterå±æ€§ï¼Œæ”¯æŒä¸‰ç§å±æ€§ï¼Œåˆ†åˆ«æ˜¯
`group category mask`


#### åœ¨ä¸¤ä¸ªgroupç›¸ç­‰çš„å‰æä¸‹


å¦‚æœä»»æ„groupå¤§äºé›¶ï¼Œåˆ™ä¸¤è€…å§‹ç»ˆç¢°æ’ï¼Œæ¯”å¦‚å¤§å®¶éƒ½æ˜¯1ï¼Œè¿™å¤§å®¶ç›¸äº’ç›´æ¥å§‹ç»ˆç¢°æ’
å¦‚æœä»»æ„groupå°äº0ï¼Œ`æ¯”å¦‚å¤§å®¶éƒ½æ˜¯-1`ï¼Œåˆ™å¤§å®¶æ°¸è¿œä¹Ÿä¸ç¢°æ’,`æˆ‘ä»¬çš„æ°´æœå°±æ˜¯ç”¨çš„è¿™ä¸ª`
é™¤ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œåˆ™æ ¹æ®categoryå’Œmaskè¿›è¡Œåˆ¤å®š


#### åœ¨ä¸¤ä¸ªgroupä¸ç›¸ç­‰çš„å‰æä¸‹


categoryï¼Œmaskåˆ¤å®šè§„åˆ™
categoryä»£è¡¨ä¸€ä¸ªç¢°æ’åˆ†ç±»ï¼Œå…¶å€¼å¯ä¸º1ï¼Œ2ï¼Œ4ï¼Œ8...ç›´åˆ° 2^31ï¼Œæ¯ä¸ªåˆšä½“è®¾ç½®ä¸€ä¸ªå€¼
maskä¸ºç¢°æ’é›†åˆï¼ˆcategoryé›†åˆï¼‰ï¼Œæ˜¯categoryç›¸ä¸çš„ç»“æœå€¼ï¼Œæ¯”å¦‚æ¥å—2ï¼Œ4ç±»å‹ï¼Œå…¶å€¼ä¸º6
aå’Œbç¢°æ’æƒ…å†µæ˜¯
`açš„maskå¿…é¡»åŒ…å«bçš„category`ï¼Œ`åŒæ—¶`bçš„maskä¹Ÿå¿…é¡»åŒ…å«açš„categoryï¼Œå³
(a.category & b.mask) !== 0 && (b.category & a.mask) !== 0


æ›´å¤šçš„è§„åˆ™å°±å»æ‰¾APIå§ã€‚


## æ€»ç»“


è‡³æ­¤ï¼Œ`ç®€å•`çš„åˆ‡æ°´æœæ¸¸æˆå°±å®Œäº‹äº†ã€‚ é€»è¾‘ä¹Ÿå¾ˆç®€é™‹ã€‚ä»…ä½œä¸ºå­¦ä¹ äº¤æµä½¿ç”¨ã€‚


> ç†Šä¸œèµ·ï¼šâ€œæˆ‘å¥½äº†, ä½ å­¦feiäº†å—â€

ç‹æ¢¦ä½³ï¼šâ€œå•¥ä¹Ÿä¸æ˜¯~â€

